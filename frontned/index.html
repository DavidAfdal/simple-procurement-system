<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.10.5/sweetalert2.all.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="bg-gray-50">
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center px-4">
        <div class="max-w-md w-full bg-white rounded-lg shadow-lg p-8">
            <div class="text-center mb-8">
                <i class="fas fa-box-open text-5xl text-blue-600 mb-4"></i>
                <h2 class="text-3xl font-bold text-gray-800">Inventory System</h2>
                <p class="text-gray-600 mt-2">Sign in to your account</p>
            </div>
            <form id="loginForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-semibold mb-2">Email</label>
                    <input type="email" id="loginEmail" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Enter your email">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-semibold mb-2">Password</label>
                    <input type="password" id="loginPassword" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Enter your password">
                </div>
                <button type="submit" 
                        class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-200">
                    Sign In
                </button>
            </form>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboardPage" class="hidden min-h-screen">
        <!-- Navbar -->
        <nav class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <i class="fas fa-box-open text-2xl text-blue-600 mr-3"></i>
                        <span class="text-xl font-bold text-gray-800">Inventory System</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="userEmail" class="text-gray-600"></span>
                        <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Navigation Tabs -->
            <div class="mb-6 border-b border-gray-200">
                <nav class="flex space-x-8">
                    <button class="tab-btn active pb-4 px-1 border-b-2 border-blue-600 font-semibold text-blue-600" data-tab="inventory">
                        <i class="fas fa-boxes mr-2"></i>Inventory
                    </button>
                    <button class="tab-btn pb-4 px-1 border-b-2 border-transparent font-semibold text-gray-500 hover:text-gray-700" data-tab="purchase">
                        <i class="fas fa-shopping-cart mr-2"></i>Create Purchase
                    </button>
                </nav>
            </div>

            <!-- Inventory Tab -->
            <div id="inventoryTab" class="tab-content">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">Inventory List</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Create Purchase Tab -->
            <div id="purchaseTab" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">Create Purchase Order</h3>
                    
                    <!-- Supplier Selection -->
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Select Supplier</label>
                        <select id="supplierSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">-- Choose Supplier --</option>
                        </select>
                    </div>

                    <!-- Add Item Form -->
                    <div class="border-t border-gray-200 pt-6 mb-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Add Items</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2">Item</label>
                                <select id="itemSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">-- Choose Item --</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2">Quantity</label>
                                <input type="number" id="itemQty" min="1" value="1"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       placeholder="Enter quantity">
                            </div>
                            <div class="flex items-end">
                                <button id="addItemBtn" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition">
                                    <i class="fas fa-plus mr-2"></i>Add to Cart
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Cart Table -->
                    <div class="border-t border-gray-200 pt-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Shopping Cart</h4>
                        <div class="overflow-x-auto mb-6">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="cartTableBody" class="bg-white divide-y divide-gray-200">
                                    <tr id="emptyCartMsg">
                                        <td colspan="3" class="px-6 py-8 text-center text-gray-500">
                                            <i class="fas fa-shopping-cart text-4xl mb-2"></i>
                                            <p>Your cart is empty</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Submit Button -->
                        <div class="flex justify-end">
                            <button id="submitOrderBtn" disabled
                                    class="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                                <i class="fas fa-paper-plane mr-2"></i>Submit Order
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = 'http://localhost:8000/api';
        
        
        let cart = [];
        let suppliers = [];
        let items = [];

        
        function apiRequest(endpoint, method = 'GET', data = null) {
            const token = localStorage.getItem('token');
            const config = {
                url: `${API_BASE_URL}${endpoint}`,
                method: method,
                headers: {}
            };

            if (token) {
                config.headers['Authorization'] = `Bearer ${token}`;
            }

            if (data) {
                config.contentType = 'application/json';
                config.data = JSON.stringify(data);
            }

            return $.ajax(config);
        }

        // Toast notification helper
        function showToast(icon, title, text) {
            Swal.fire({
                icon: icon,
                title: title,
                text: text,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        }

        // Check if user is logged in
        function checkAuth() {
            const token = localStorage.getItem('token');
            if (token) {
                const userEmail = localStorage.getItem('userEmail');
                $('#userEmail').text(userEmail);
                $('#loginPage').hide();
                $('#dashboardPage').show();
                loadInventory();
                loadSuppliers();
                loadItems();
            } else {
                $('#loginPage').show();
                $('#dashboardPage').hide();
            }
        }

        // Login Form Submit
        $('#loginForm').on('submit', function(e) {
            e.preventDefault();
            
            const email = $('#loginEmail').val();
            const password = $('#loginPassword').val();

            apiRequest('/login', 'POST', { email, password })
                .done(function(response) {
                    localStorage.setItem('token', response.token);
                    localStorage.setItem('userEmail', email);
                    showToast('success', 'Success!', 'Login successful');
                    checkAuth();
                })
                .fail(function(xhr) {
                    const errorMsg = xhr.responseJSON?.message || 'Login failed. Please check your credentials.';
                    showToast('error', 'Login Failed', errorMsg);
                });
        });

        // Logout
        $('#logoutBtn').on('click', function() {
            Swal.fire({
                title: 'Are you sure?',
                text: "You will be logged out",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, logout'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem('token');
                    localStorage.removeItem('userEmail');
                    cart = [];
                    showToast('success', 'Logged Out', 'You have been logged out successfully');
                    checkAuth();
                }
            });
        });

        // Tab Navigation
        $('.tab-btn').on('click', function() {
            const tab = $(this).data('tab');
            
            $('.tab-btn').removeClass('active border-blue-600 text-blue-600')
                        .addClass('border-transparent text-gray-500');
            $(this).removeClass('border-transparent text-gray-500')
                   .addClass('active border-blue-600 text-blue-600');
            
            $('.tab-content').hide();
            $(`#${tab}Tab`).show();
        });

        // Load Inventory
        function loadInventory() {
            apiRequest('/items')
                .done(function(response) {
                    const tbody = $('#inventoryTableBody');
                    tbody.empty();
                    
                    if (response.data && response.data.length > 0) {
                        response.data.forEach(function(item) {
                            const stockClass = item.stock < 10 ? 'text-red-600 font-semibold' : 'text-gray-900';
                            const statusBadge = item.stock < 10 
                                ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Low Stock</span>'
                                : '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">In Stock</span>';
                            
                            tbody.append(`
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.sku}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm ${stockClass}">${item.stock}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">${statusBadge}</td>
                                </tr>
                            `);
                        });
                    } else {
                        tbody.append('<tr><td colspan="4" class="px-6 py-8 text-center text-gray-500">No items found</td></tr>');
                    }
                })
                .fail(function(xhr) {
                    showToast('error', 'Error', 'Failed to load inventory data');
                });
        }

        // Load Suppliers
        function loadSuppliers() {
            apiRequest('/suppliers')
                .done(function(response) {
                    suppliers = response.data || [];
                    const select = $('#supplierSelect');
                    select.find('option:not(:first)').remove();
                    
                    suppliers.forEach(function(supplier) {
                        select.append(`<option value="${supplier.id}">${supplier.name}</option>`);
                    });
                })
                .fail(function(xhr) {
                    showToast('error', 'Error', 'Failed to load suppliers');
                });
        }

        // Load Items
        function loadItems() {
            apiRequest('/items')
                .done(function(response) {
                    items = response.data || [];
                    const select = $('#itemSelect');
                    select.find('option:not(:first)').remove();
                    
                    items.forEach(function(item) {
                        select.append(`<option value="${item.id}" data-name="${item.name}">${item.name} (Stock: ${item.stock})</option>`);
                    });
                })
                .fail(function(xhr) {
                    showToast('error', 'Error', 'Failed to load items');
                });
        }

        // Add Item to Cart
        $('#addItemBtn').on('click', function() {
            const supplierId = $('#supplierSelect').val();
            const itemId = $('#itemSelect').val();
            const itemName = $('#itemSelect option:selected').data('name');
            const qty = parseInt($('#itemQty').val());

            if (!supplierId) {
                showToast('warning', 'Supplier Required', 'Please select a supplier first');
                return;
            }

            if (!itemId) {
                showToast('warning', 'Item Required', 'Please select an item');
                return;
            }

            if (qty < 1) {
                showToast('warning', 'Invalid Quantity', 'Quantity must be at least 1');
                return;
            }

            // Check if item already in cart
            const existingIndex = cart.findIndex(c => c.item_id === parseInt(itemId));
            if (existingIndex !== -1) {
                cart[existingIndex].qty += qty;
            } else {
                cart.push({
                    item_id: parseInt(itemId),
                    item_name: itemName,
                    qty: qty
                });
            }

            renderCart();
            $('#itemSelect').val('');
            $('#itemQty').val('1');
            showToast('success', 'Added', 'Item added to cart');
        });

        // Render Cart Table (Event Delegation for Remove Button)
        function renderCart() {
            const tbody = $('#cartTableBody');
            tbody.empty();

            if (cart.length === 0) {
                tbody.append(`
                    <tr id="emptyCartMsg">
                        <td colspan="3" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-shopping-cart text-4xl mb-2"></i>
                            <p>Your cart is empty</p>
                        </td>
                    </tr>
                `);
                $('#submitOrderBtn').prop('disabled', true);
            } else {
                cart.forEach(function(item, index) {
                    tbody.append(`
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.item_name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.qty}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <button class="remove-item-btn text-red-600 hover:text-red-800" data-index="${index}">
                                    <i class="fas fa-trash mr-1"></i>Remove
                                </button>
                            </td>
                        </tr>
                    `);
                });
                $('#submitOrderBtn').prop('disabled', false);
            }
        }

        // Event Delegation for Remove Button
        $('#cartTableBody').on('click', '.remove-item-btn', function() {
            const index = $(this).data('index');
            cart.splice(index, 1);
            renderCart();
            showToast('info', 'Removed', 'Item removed from cart');
        });

        // Submit Purchase Order
        $('#submitOrderBtn').on('click', function() {
            const supplierId = $('#supplierSelect').val();

            if (!supplierId) {
                showToast('warning', 'Supplier Required', 'Please select a supplier');
                return;
            }

            if (cart.length === 0) {
                showToast('warning', 'Empty Cart', 'Please add items to cart');
                return;
            }

            const orderData = {
                supplier_id: parseInt(supplierId),
                items: cart.map(item => ({
                    item_id: item.item_id,
                    qty: item.qty
                }))
            };

            Swal.fire({
                title: 'Confirm Order',
                text: `Submit purchase order with ${cart.length} item(s)?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, submit it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    apiRequest('/purchases', 'POST', orderData)
                        .done(function(response) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Order Submitted!',
                                text: 'Purchase order has been created successfully',
                                confirmButtonColor: '#3085d6'
                            });
                            cart = [];
                            renderCart();
                            $('#supplierSelect').val('');
                            loadInventory();
                        })
                        .fail(function(xhr) {
                            const errorMsg = xhr.responseJSON?.message || 'Failed to submit order';
                            Swal.fire({
                                icon: 'error',
                                title: 'Submission Failed',
                                text: errorMsg,
                                confirmButtonColor: '#d33'
                            });
                        });
                }
            });
        });

        // Initialize
        $(document).ready(function() {
            checkAuth();
        });
    </script>
</body>
</html>